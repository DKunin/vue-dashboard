<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Dashboard">
    <meta name="author" content="Dmitri Kunin">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/tachyons@4.6.0/css/tachyons.min.css">
    <link rel="stylesheet" href="./styles/styles.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/2.2.0/vue-router.min.js"></script>
    <script type="text/javascript" src="./scripts/tasksList.js"></script>
    <script type="text/javascript" src="./scripts/stashList.js"></script>
    <script type="text/javascript" src="./scripts/dashboard.js"></script>
    <script type="text/javascript" src="./scripts/settings.js"></script>
    <script type="text/javascript" src="./scripts/mainApp.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script type="text/javascript">
        const LOCAL_IP = 'http://10.10.12.13';
        const KANBAN_MAIN = LOCAL_IP + ':4747/api/kanban';
        const PRS = LOCAL_IP + ':4848/api/prs';

        function makeRequest(url) {
            return fetch(url)
                .then(response => {
                    if (response.status >= 200 && response.status < 300) {
                        return response.json();
                    }
                    return {};
                })
                .catch(error => {
                    return [];
                });
        }

        function updateTasks(boardId, app) {
            Promise
                .all([
                    makeRequest(
                        KANBAN_MAIN +
                            `?boardId=${boardId}&jql=assignee%20=%20currentUser()`
                    )
                ])
                .then((tasks, secondTasks) => {
                    const concatinated = tasks.reduce(
                        function(newArray, singleItem) {
                            return newArray.concat(singleItem);
                        },
                        []
                    );
                    Vue.set(app, 'tasks', concatinated);
                });
        }

        function updateStash(stashUserName, app) {
            makeRequest(PRS + '?username=' + stashUserName)
                .then(data => {
                    Vue.set(app, 'requests', data);
                });
        }

        let lastUpdate = Date.now();


        document.addEventListener('DOMContentLoaded', function () {
            Vue.component('tasksList', tasksList);
            Vue.component('stashList', stashList);
            const app = new Vue(mainApp);
            const { boardId, stashUserName, hideMaster, hideWips } = JSON.parse(
                localStorage.getItem('settings')
            )

            Vue.set(app, 'hideMaster', hideMaster);
            Vue.set(app, 'hideWips', hideWips);

            document.addEventListener(
                'visibilitychange',
                () => {
                    const timeSinceLastUpdate = Math.abs(lastUpdate - Date.now()) / 1000;
                    if (timeSinceLastUpdate > 120) {
                        updateTasks(boardId, app);
                        updateStash(stashUserName, app);
                        lastUpdate = Date.now();
                    }
                },
                false
            );
            updateTasks(boardId, app);
            updateStash(stashUserName, app);
        });
    </script>
  </body>
</html>
